{% extends 'base.html' %}
{% load markdownify %}
{% block title %}CBT Results - {{ topic.name }} - LagSciPrep{% endblock %}
{% block og_title %}CBT Results - {{ topic.name }} - LagSciPrep{% endblock %}
{% block og_description %}View your CBT exam results for {{ topic.name }} on LagSciPrep{% endblock %}
{% block content %}
<div class="results-container">
    <!-- Results Header -->
    <div class="results-header text-center mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'course_detail' topic.course.id %}">{{ course.name }}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Exam Results</li>
                    </ol>
                 </nav>
                     <div class="mt-3 text-center">
                    <a href="https://whatsapp.com/channel/0029VbBtigpJZg43t3dggG03" target="_blank" class="btn btn-outline-success btn-sm">
                        <i class="fab fa-whatsapp me-1"></i>Join Our WhatsApp Channel for Updates
                    </a>
                </div>
                
                <div class="mb-4">
                    <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                    <h1 class="display-5 fw-bold text-primary">Exam Completed!</h1>
                    <p class="lead text-muted">You have finished the {{ course.name }} assessment</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="card card-custom">
                <div class="card-header card-header-custom text-center">
                    <h3 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Performance Summary</h3>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- Score Card -->
                        <div class="col-md-4 mb-4">
                            <div class="performance-card">
                                <div class="performance-icon score">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h3 class="performance-value">{{ score }}/{{ total }}</h3>
                                <p class="performance-label">Raw Score</p>
                            </div>
                        </div>
                        
                        <!-- Percentage Card -->
                        <div class="col-md-4 mb-4">
                            <div class="performance-card">
                                <div class="performance-icon percentage {% if percent >= 70 %}excellent{% elif percent >= 50 %}good{% else %}poor{% endif %}">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <h3 class="performance-value">{{ percent|floatformat:1 }}%</h3>
                                <p class="performance-label">Percentage</p>
                            </div>
                        </div>
                        
                        <!-- Performance Rating -->
                        <div class="col-md-4 mb-4">
                            <div class="performance-card">
                                <div class="performance-icon rating">
                                    <i class="fas fa-medal"></i>
                                </div>
                                <h3 class="performance-value">
                                    {% if percent >= 90 %}A+
                                    {% elif percent >= 80 %}A
                                    {% elif percent >= 70 %}B
                                    {% elif percent >= 60 %}C
                                    {% elif percent >= 50 %}D
                                    {% else %}F
                                    {% endif %}
                                </h3>
                                <p class="performance-label">Grade</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Visualization -->
                    <div class="progress-visualization mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Correct Answers</span>
                            <span class="text-muted">{{ score }}/{{ total }}</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% widthratio score total 100 %}%;"
                                 aria-valuenow="{{ score }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ total }}">
                                {{ score }} Correct
                            </div>
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {% widthratio total|add:"-"|add:score total 100 %}%;"
                                 aria-valuenow="{{ total|add:"-"|add:score }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="{{ total }}">
                                {{ total|add:"-"|add:score }} Incorrect
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Section -->
    {% if failed_questions %}
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card card-custom">
                <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0"><i class="fas fa-search me-2"></i>Questions Review</h3>
                    <span class="badge bg-danger">{{ failed_questions|length }} questions to review</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Learning Opportunity:</strong> Reviewing incorrect answers helps strengthen your understanding.
                    </div>
                    
                    <div class="review-questions">
                        {% for item in failed_questions %}
                        <div class="review-item card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Question {{ forloop.counter }}</h5>
                            </div>
                            <div class="card-body">
                                <!-- Question -->
                                <div class="question-section mb-4">
                                    <h6 class="text-muted mb-2">Question:</h6>
                                    <div class="question-content p-3 bg-light rounded">
                                        {{ item.question.question_text|safe }}
                                    </div>
                                </div>
                                
                                <!-- Answers Comparison -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="answer-card incorrect">
                                            <h6 class="answer-header">
                                                <i class="fas fa-times-circle me-2"></i>Your Answer
                                            </h6>
                                            <div class="answer-content">
                                                {{ item.your_answer }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="answer-card correct">
                                            <h6 class="answer-header">
                                                <i class="fas fa-check-circle me-2"></i>Correct Answer
                                            </h6>
                                            <div class="answer-content">
                                                {{ item.correct_answer }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Explanation -->
                                <div class="explanation-section">
                                    <h6 class="text-muted mb-2">Explanation:</h6>
                                    <div class="explanation-content p-3 bg-info bg-opacity-10 rounded">
                                        {% if item.question.course.name|lower in "mathematics,physics,chemistry" %}
                                            {{ item.explanation|safe }}
                                        {% else %}
                                            {{ item.explanation|markdownify }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Perfect Score Celebration -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card card-custom text-center">
                <div class="card-body py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h3 class="text-success">Perfect Score!</h3>
                    <p class="lead text-muted mb-4">Congratulations! You answered all questions correctly.</p>
                    <div class="celebration-animation">
                        <i class="fas fa-star text-warning me-2"></i>
                        <i class="fas fa-star text-warning me-2"></i>
                        <i class="fas fa-star text-warning me-2"></i>
                        <span class="fw-bold">Outstanding Performance!</span>
                        <i class="fas fa-star text-warning ms-2"></i>
                        <i class="fas fa-star text-warning ms-2"></i>
                        <i class="fas fa-star text-warning ms-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row justify-content-center mt-5">
        <div class="col-lg-8 text-center">
            <div class="action-buttons">
                <a href="{% url 'course_detail' topic.course.id %}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-arrow-left me-2"></i>Back to Course
                </a>
                <a href="{% url 'start_topic_cbt' topic.course.id %}" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-redo me-2"></i>Retry Exam
                </a>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-home me-2"></i>Return to Dashboard
                </a>
            </div>
            
            <!-- Additional Resources -->
            <div class="mt-4">
                <p class="text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Your results have been saved to your grade book.
                </p>
                <div class="mt-3 text-center">
                    <a href="https://whatsapp.com/channel/0029VbBtigpJZg43t3dggG03" target="_blank" class="btn btn-outline-success btn-sm">
                        <i class="fab fa-whatsapp me-1"></i>Join Our WhatsApp Channel for Updates
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .results-container {
        padding-bottom: 3rem;
    }
    
    .performance-card {
        padding: 1.5rem;
    }
    
    .performance-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2rem;
    }
    
    .performance-icon.score {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    
    .performance-icon.percentage.excellent {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
    }
    
    .performance-icon.percentage.good {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
    }
    
    .performance-icon.percentage.poor {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }
    
    .performance-icon.rating {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
    }
    
    .performance-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .performance-label {
        color: var(--gray);
        font-weight: 500;
        margin-bottom: 0;
    }
    
    .progress-visualization .progress-bar {
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .review-item {
        border-left: 4px solid #e74c3c;
    }
    
    .answer-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        height: 100%;
    }
    
    .answer-card.incorrect {
        border-left: 4px solid #e74c3c;
    }
    
    .answer-card.correct {
        border-left: 4px solid #2ecc71;
    }
    
    .answer-header {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .answer-card.incorrect .answer-header {
        color: #e74c3c;
    }
    
    .answer-card.correct .answer-header {
        color: #2ecc71;
    }
    
    .answer-content {
        font-weight: 500;
        font-size: 1.1rem;
    }
    
    .question-content, .explanation-content {
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .celebration-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .action-buttons .btn {
        min-width: 180px;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .performance-value {
            font-size: 2rem;
        }
        
        .performance-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .action-buttons .btn {
            min-width: 100%;
            margin-bottom: 1rem;
        }
    }
</style>

<script>
    // Add some interactive elements
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scrolling to review section
        const reviewItems = document.querySelectorAll('.review-item');
        reviewItems.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                item.style.transition = 'all 0.5s ease';
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
            }, index * 200);
        });
        
        // Performance celebration for high scores
        const percent = {{ percent }};
        if (percent >= 80) {
            const celebration = document.createElement('div');
            celebration.className = 'text-center mt-3';
            celebration.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-trophy me-2"></i>
                    <strong>Excellent work!</strong> You're mastering this material!
                </div>
            `;
            document.querySelector('.performance-summary').appendChild(celebration);
        }
    });
</script>
{% endblock %}