{% extends 'base.html' %}
{% block title %}CBT Question - {{ course.name }} - LagSciPrep{% endblock %}
{% block og_title %}CBT Question - {{ course.name }} - LagSciPrep{% endblock %}
{% block og_description %}Answer CBT questions for {{ course.name }} on LagSciPrep{% endblock %}
{% block content %}
<div class="container mt-4">
    <h3>{{ course.name }} CBT</h3>
    <div id="timer" class="mb-3 text-danger fw-bold"></div>
    <div id="cbtApp"></div>
</div>

<script>
let QUESTIONS = [];
let answers = {};
let index = 0;
let learnMode = false;
let seconds = 0;

fetch("{% url 'cbt_data' %}")
.then(res => res.json())
.then(data => {
    QUESTIONS = data.questions;
    learnMode = data.learn_mode;
    seconds = data.remaining;
    render();
    startTimer();
});

function render() {
    const q = QUESTIONS[index];

    let html = `
        <h5>Question ${index + 1} / ${QUESTIONS.length}</h5>
        <p>${q.question}</p>
    `;

    for (let key in q.options) {
        html += `
            <div>
                <label>
                    <input type="radio" name="opt"
                        value="${key}"
                        ${answers[q.id] === key ? 'checked' : ''}
                        onchange="selectAns(${q.id}, '${key}')">
                    ${q.options[key]}
                </label>
            </div>
        `;
    }

    html += `<div class="mt-3">`;
    if (index > 0) html += `<button onclick="prev()">Prev</button> `;
    if (index < QUESTIONS.length - 1)
        html += `<button onclick="next()">Next</button>`;
    else
        html += `<button onclick="submitExam()">Submit</button>`;
    html += `</div>`;

    document.getElementById('cbtApp').innerHTML = html;
}

function selectAns(qid, val) {
    answers[qid] = val;

    if (learnMode) {
        const q = QUESTIONS[index];
        if (val !== q.correct) {
            alert("Wrong âŒ\n" + q.explanation);
        }
    }
}

function next() {
    index++;
    render();
}

function prev() {
    index--;
    render();
}

function submitExam() {
    if (!confirm("Submit exam?")) return;

    fetch("{% url 'cbt_submit_answers' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({answers})
    }).then(() => {
        window.location.href = "{% url 'cbt_submit' %}";
    });
}

function startTimer() {
    const t = document.getElementById('timer');
    setInterval(() => {
        if (seconds <= 0) submitExam();
        let m = Math.floor(seconds / 60);
        let s = seconds % 60;
        t.innerText = `${m}:${s.toString().padStart(2,'0')}`;
        seconds--;
    }, 1000);
}
</script>
{% endblock %}
